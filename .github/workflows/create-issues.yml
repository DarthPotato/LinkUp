name: Copy Issues from TodoApp

on:
  push:
    branches:
      - copilot/copy-issues-user-stories
  workflow_dispatch:

jobs:
  create-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Create labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          create_label() {
            gh label create "$1" --color "$2" --description "$3" --repo "$REPO" 2>/dev/null || true
          }
          create_label "US 1"        "0075ca" "Account Creation"
          create_label "US 2"        "e4e669" "User Login"
          create_label "US 3"        "d93f0b" "Create a Task"
          create_label "US 4"        "0e8a16" "Mark Task as Complete"
          create_label "US 5"        "1d76db" "Edit Task Details"
          create_label "US 6"        "5319e7" "Zen Quotes App"
          create_label "enhancement" "a2eeef" "New feature or request"

      - name: Create US1 issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          TITLE="US1: Account Creation"
          existing=$(gh issue list --repo "$REPO" --search "\"$TITLE\" in:title" --json title --jq '.[].title' 2>/dev/null)
          if echo "$existing" | grep -qF "$TITLE"; then
            echo "Already exists, skipping."
          else
            cat > /tmp/body.md << 'EOF'
          AS A user,
          I WANT TO create an account using email/password authentication,
          TO store and manage my to-do list items on the Internet
          SO THAT I can access and manage my tasks from the app across different devices.

          SCENARIO: Successful Account Creation
          GIVEN the user is on the sign-up screen of the ToDo List app,
          WHEN the user enters a valid email address and a strong password,
          AND clicks the "Create Account" button,
          THEN an account should be created in the Firebase authentication system,
          WITHIN 3 seconds,
          AND the user should be redirected to the main to-do list screen
          WITHIN 2 seconds.

          SCENARIO: Account Already Exists
          GIVEN the user is on the sign-up screen of the ToDo List app,
          WHEN the user enters an email address that is already associated with an existing account,
          AND clicks the "Create Account" button,
          THEN the system should display an error message stating "An account with this email already exists"
          WITHIN 1 second,
          AND prompt the user to either log in or recover their password.

          SCENARIO: Invalid Email Address Format
          GIVEN the user is on the sign-up screen of the ToDo List app,
          WHEN the user enters an email address that does not follow a valid email format (e.g., "userexample.com" or "user@.com"),
          AND clicks the "Create Account" button,
          THEN the system should display an error message stating "Please enter a valid email address"
          WITHIN 1 second,
          AND prevent the account creation process from proceeding.

          SCENARIO: Weak Password
          GIVEN the user is on the sign-up screen of the ToDo List app,
          WHEN the user enters a password that does not meet the strength requirements (e.g., less than 8 characters, no uppercase letters, or lacks numbers/special characters),
          AND clicks the "Create Account" button,
          THEN the system should display an error message stating "Your password is too weak. Please choose a stronger password."
          WITHIN 1 second,
          AND prevent the account creation process from proceeding.

          SCENARIO: Network Error During Account Creation
          GIVEN the user is on the sign-up screen of the ToDo List app,
          WHEN the user enters a valid email address and password,
          AND clicks the "Create Account" button,
          THEN if a network error occurs, the system should display an error message stating "Network error. Please try again later."
          WITHIN 2 seconds,
          AND allow the user to retry the account creation process once the network is stable.

          SCENARIO: Password Recovery Prompt
          GIVEN the user attempts to create an account with an existing email,
          WHEN the system displays the "Account already exists" error,
          AND the user selects the "Forgot Password" option,
          THEN the system should prompt the user to enter their email for password recovery
          WITHIN 1 second,
          AND send a password reset email
          WITHIN 30 seconds.
          EOF
            gh issue create --repo "$REPO" --title "$TITLE" --label "US 1" --body-file /tmp/body.md
          fi

      - name: Create US2 issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          TITLE="US2: User Login"
          existing=$(gh issue list --repo "$REPO" --search "\"$TITLE\" in:title" --json title --jq '.[].title' 2>/dev/null)
          if echo "$existing" | grep -qF "$TITLE"; then
            echo "Already exists, skipping."
          else
            cat > /tmp/body.md << 'EOF'
          AS A user,
          I WANT TO log into my account using my email and password,
          SO THAT I can securely access my personal to-do list
          AND manage my tasks from any device.

          SCENARIO: Successful Login
          GIVEN the user has a registered account and is on the login screen,
          WHEN the user enters a valid email address and correct password,
          AND clicks the "Log In" button,
          THEN the system should authenticate the user via Firebase authentication
          WITHIN 3 seconds,
          AND redirect the user to the main task list screen
          WITHIN 2 seconds.

          SCENARIO: Incorrect Password
          GIVEN the user is on the login screen,
          WHEN the user enters a valid email address and an incorrect password,
          AND clicks the "Log In" button,
          THEN the system should display an error message stating "Incorrect email or password."
          WITHIN 1 second,
          AND remain on the login screen to allow the user to retry.

          SCENARIO: Unregistered Email
          GIVEN the user is on the login screen,
          WHEN the user enters an email address that does not correspond to any registered account,
          AND clicks the "Log In" button,
          THEN the system should display an error message stating "No account found with this email."
          WITHIN 1 second,
          AND prompt the user to create a new account.

          SCENARIO: Empty Fields
          GIVEN the user is on the login screen,
          WHEN the user leaves either the email or password field empty,
          AND clicks the "Log In" button,
          THEN the system should display a validation error message
          WITHIN 1 second,
          AND prevent the login process from proceeding.

          SCENARIO: Network Error During Login
          GIVEN the user is on the login screen,
          WHEN the user enters valid credentials,
          AND clicks the "Log In" button,
          THEN if a network error occurs, the system should display an error message stating "Network error. Please try again later."
          WITHIN 2 seconds,
          AND allow the user to retry once the network is stable.
          EOF
            gh issue create --repo "$REPO" --title "$TITLE" --label "US 2" --body-file /tmp/body.md
          fi

      - name: Create US3 issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          TITLE="US3: Create a Task"
          existing=$(gh issue list --repo "$REPO" --search "\"$TITLE\" in:title" --json title --jq '.[].title' 2>/dev/null)
          if echo "$existing" | grep -qF "$TITLE"; then
            echo "Already exists, skipping."
          else
            cat > /tmp/body.md << 'EOF'
          AS A user,
          I WANT TO create a new task by entering a title and optional details,
          SO THAT I can add items to my to-do list to track work I need to complete.

          SCENARIO: Successful Task Creation
          GIVEN the user is on the main task list screen,
          WHEN the user taps the "+" floating action button,
          AND enters a task title in the provided field,
          AND optionally adds details to the task,
          AND submits the form,
          THEN a new task should be saved to the Firebase database associated with the user's account
          WITHIN 2 seconds,
          AND the task should appear in the task list on the main screen
          WITHIN 1 second.

          SCENARIO: Missing Task Title
          GIVEN the user is on the add task bottom sheet,
          WHEN the user leaves the title field empty,
          AND attempts to submit the form,
          THEN the system should display a validation error stating "Please enter a task title"
          WITHIN 1 second,
          AND prevent the task from being saved until a title is provided.

          SCENARIO: Task with Details
          GIVEN the user is on the add task bottom sheet,
          WHEN the user enters both a title and details for the task,
          AND submits the form,
          THEN the task should be saved with both the title and details preserved
          WITHIN 2 seconds,
          AND be accessible in the task detail view.

          SCENARIO: Network Error During Task Creation
          GIVEN the user is on the add task bottom sheet,
          WHEN the user submits the form,
          THEN if a network error occurs, the system should display an error message stating "Failed to save task. Please try again."
          WITHIN 2 seconds,
          AND retain the task input so the user can retry.
          EOF
            gh issue create --repo "$REPO" --title "$TITLE" --label "US 3" --body-file /tmp/body.md
          fi

      - name: Create US4 issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          TITLE="US4: Mark Task as Complete"
          existing=$(gh issue list --repo "$REPO" --search "\"$TITLE\" in:title" --json title --jq '.[].title' 2>/dev/null)
          if echo "$existing" | grep -qF "$TITLE"; then
            echo "Already exists, skipping."
          else
            cat > /tmp/body.md << 'EOF'
          AS A user,
          I WANT TO mark a task as completed using a checkbox,
          SO THAT I can track my progress and remove completed items from my active task list.

          SCENARIO: Successful Task Completion
          GIVEN the user is on the main task list screen and has at least one active task,
          WHEN the user taps the checkbox next to a task,
          THEN the task should be marked as completed in the Firebase database
          WITHIN 2 seconds,
          AND the task should be removed from the active task list
          WITHIN 1 second.

          SCENARIO: Viewing Completed Tasks
          GIVEN the user has marked one or more tasks as completed,
          WHEN the user navigates to the completed tasks section,
          THEN all tasks that have been marked as completed should be displayed
          WITHIN 2 seconds.

          SCENARIO: No Active Tasks Remain
          GIVEN the user has marked all their tasks as completed,
          WHEN the last task is marked as completed,
          THEN the active task list should display an empty state message
          WITHIN 1 second,
          AND the completed task should appear in the completed tasks section.

          SCENARIO: Network Error During Task Completion
          GIVEN the user is on the main task list screen,
          WHEN the user taps the checkbox to mark a task as completed,
          THEN if a network error occurs, the system should display an error message stating "Failed to update task. Please try again."
          WITHIN 2 seconds,
          AND the task should remain in the active list until the update is confirmed.
          EOF
            gh issue create --repo "$REPO" --title "$TITLE" --label "US 4" --body-file /tmp/body.md
          fi

      - name: Create US5 issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          TITLE="US5: Edit Task Details"
          existing=$(gh issue list --repo "$REPO" --search "\"$TITLE\" in:title" --json title --jq '.[].title' 2>/dev/null)
          if echo "$existing" | grep -qF "$TITLE"; then
            echo "Already exists, skipping."
          else
            cat > /tmp/body.md << 'EOF'
          AS A user,
          I WANT TO view and edit the title and details of an existing task,
          SO THAT I can update task information as my needs change.

          SCENARIO: Viewing Task Details
          GIVEN the user is on the main task list screen,
          WHEN the user taps on a task in the list,
          THEN the task detail screen should open, displaying the task's current title and details
          WITHIN 2 seconds.

          SCENARIO: Successful Task Edit
          GIVEN the user is on the task detail screen,
          WHEN the user taps the edit icon to enter editing mode,
          AND modifies the task title or details in the text fields,
          AND taps the "Update Task" button,
          THEN the task should be updated in the Firebase database with the new information
          WITHIN 2 seconds,
          AND the editing mode should be exited automatically
          WITHIN 1 second.

          SCENARIO: Edit Without Changes
          GIVEN the user is on the task detail screen in editing mode,
          WHEN the user taps the "Update Task" button without making any changes,
          THEN the system should still save the task (with unchanged content)
          WITHIN 2 seconds,
          AND exit editing mode.

          SCENARIO: Cancel Edit
          GIVEN the user is on the task detail screen in editing mode,
          WHEN the user navigates back without tapping "Update Task",
          THEN any unsaved changes should be discarded,
          AND the task should retain its original title and details.

          SCENARIO: Network Error During Edit
          GIVEN the user is on the task detail screen in editing mode,
          WHEN the user makes changes and taps "Update Task",
          THEN if a network error occurs, the system should display an error message stating "Failed to update task. Please try again."
          WITHIN 2 seconds,
          AND remain in editing mode so the user can retry.
          EOF
            gh issue create --repo "$REPO" --title "$TITLE" --label "US 5" --body-file /tmp/body.md
          fi

      - name: Create US6 issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          TITLE="US6: Zen Quotes App"
          existing=$(gh issue list --repo "$REPO" --search "\"$TITLE\" in:title" --json title --jq '.[].title' 2>/dev/null)
          if echo "$existing" | grep -qF "$TITLE"; then
            echo "Already exists, skipping."
          else
            cat > /tmp/body.md << 'EOF'
          AS A user,
          I WANT TO view Zen quotes in the app
          TO feel motivated and practice mindfulness SO THAT I can stay calm and focused while managing my tasks.

          SCENARIO: View Zen quotes list
          GIVEN the user is on the app home screen
          WHEN the user navigates to the Zen Quotes screen,
          THEN the app displays a list of Zen quotes
          WITHIN 2 seconds AND the list is readable and scrollable WITHIN 1 second.

          SCENARIO: Refresh or load a new quote
          GIVEN the user is on the Zen Quotes screen
          WHEN the user requests a new quote,
          THEN the app displays a different Zen quote
          WITHIN 2 seconds AND the quote text is not blank WITHIN 1 second.

          SCENARIO: Save a quote to favorites
          GIVEN the user is viewing a Zen quote
          WHEN the user taps the favorite/save action,
          THEN the quote is saved to the user's favorites list
          WITHIN 1 second AND the quote appears in Favorites the next time the user opens Favorites WITHIN 2 seconds.

          SCENARIO: Share a quote
          GIVEN the user is viewing a Zen quote
          WHEN the user taps the share action,
          THEN the system share sheet opens with the quote text pre-filled
          WITHIN 2 seconds AND the shared text matches the displayed quote WITHIN 1 second.
          EOF
            gh issue create --repo "$REPO" --title "$TITLE" --label "US 6" --body-file /tmp/body.md
          fi

      - name: Create subtask issues for US1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          for TITLE in \
            "Create app signup screen UI" \
            "Create Firebase Authentication" \
            "Create account creation logic in app"; do
            existing=$(gh issue list --repo "$REPO" --search "\"$TITLE\" in:title" --json title --jq '.[].title' 2>/dev/null)
            if echo "$existing" | grep -qF "$TITLE"; then
              echo "Already exists, skipping: $TITLE"
            else
              gh issue create --repo "$REPO" --title "$TITLE" --label "US 1" --body ""
              echo "Created: $TITLE"
            fi
          done

      - name: Create Zen Quotes enhancement issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          TITLE="Display a random Zen Quote on Tasks page to inspire users"
          existing=$(gh issue list --repo "$REPO" --search "\"$TITLE\" in:title" --json title --jq '.[].title' 2>/dev/null)
          if echo "$existing" | grep -qF "$TITLE"; then
            echo "Already exists, skipping."
          else
            cat > /tmp/body.md << 'EOF'
          **User Story**
          As a user, I want to see a random inspirational quote from Zen Quotes displayed on the Tasks page each time it is loaded, so I feel motivated while using the app.

          **Acceptance Criteria:**
          - The Tasks page displays a new inspirational quote each time it loads.
          - Quotes are sourced from Zen Quotes (no API key required).
          - The quote appears prominently above the task list.

          **Additional Context:**
          Zen Quotes API documentation: https://zenquotes.io/

          ---
          **Tasks:**
          - Create API integration to retrieve quotes.
          - Update Tasks page UI to display the quote.
          - Write tests for API integration and UI rendering.
          EOF
            gh issue create --repo "$REPO" --title "$TITLE" --label "enhancement" --body-file /tmp/body.md
          fi

          TITLE="Create API call for Zen Quotes and handle random quote data"
          existing=$(gh issue list --repo "$REPO" --search "\"$TITLE\" in:title" --json title --jq '.[].title' 2>/dev/null)
          if echo "$existing" | grep -qF "$TITLE"; then
            echo "Already exists, skipping."
          else
            cat > /tmp/body.md << 'EOF'
          **Task**: Create API integration to retrieve random inspirational quotes from Zen Quotes.
          - Research Zen Quotes documentation and confirm endpoint usage.
          - Implement Dart/Flutter code to call Zen Quotes API (https://zenquotes.io/api/random).
          - Parse and handle quote data for display.
          - Ensure calls work without API key.

          Related to User Story: Display a random Zen Quote on Tasks page to inspire users.
          EOF
            gh issue create --repo "$REPO" --title "$TITLE" --label "enhancement" --body-file /tmp/body.md
          fi

          TITLE="Update Tasks page UI to display Zen Quote"
          existing=$(gh issue list --repo "$REPO" --search "\"$TITLE\" in:title" --json title --jq '.[].title' 2>/dev/null)
          if echo "$existing" | grep -qF "$TITLE"; then
            echo "Already exists, skipping."
          else
            cat > /tmp/body.md << 'EOF'
          **Task**: Update Tasks page UI to display the retrieved Zen Quote.
          - Design and position quote display above task list.
          - Ensure text is styled for inspiration and readability.
          - Integrate quote fetching logic into page load lifecycle.

          Related to User Story: Display a random Zen Quote on Tasks page to inspire users.
          EOF
            gh issue create --repo "$REPO" --title "$TITLE" --label "enhancement" --body-file /tmp/body.md
          fi

          TITLE="Write tests for Zen Quotes API and Tasks page UI"
          existing=$(gh issue list --repo "$REPO" --search "\"$TITLE\" in:title" --json title --jq '.[].title' 2>/dev/null)
          if echo "$existing" | grep -qF "$TITLE"; then
            echo "Already exists, skipping."
          else
            cat > /tmp/body.md << 'EOF'
          **Task**: Write tests for API integration and UI rendering of Zen Quotes.
          - Write unit tests for API call and quote parsing.
          - Write integration tests for quote being shown in Tasks page.
          - Validate quote appears each time Tasks page loads.

          Related to User Story: Display a random Zen Quote on Tasks page to inspire users.
          EOF
            gh issue create --repo "$REPO" --title "$TITLE" --label "enhancement" --body-file /tmp/body.md
          fi
